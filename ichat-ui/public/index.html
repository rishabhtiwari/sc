<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iChat Assistant</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f172a;
      color: #f1f5f9;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #a855f7, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #334155;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #64748b;
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Immediate connectivity test - runs before React components load
    window.addEventListener('load', async () => {
      console.log('ðŸš€ Page loaded - running immediate connectivity test...');

      try {
        console.log('ðŸ§ª Testing direct fetch to API...');
        const response = await fetch('http://127.0.0.1:8080/api/chat/test', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Origin': window.location.origin
          },
          mode: 'cors'
        });

        console.log('ðŸ“¡ Direct fetch response status:', response.status);
        console.log('ðŸ“‹ Direct fetch response headers:', Object.fromEntries(response.headers.entries()));

        if (response.ok) {
          const data = await response.json();
          console.log('âœ… Direct fetch SUCCESS:', data);
          console.log('ðŸŽ¯ API is reachable from browser!');
        } else {
          console.error('âŒ Direct fetch failed with status:', response.status);
        }
      } catch (error) {
        console.error('âŒ Direct fetch ERROR:', error);
        console.error('ðŸ” Error details:', {
          name: error.name,
          message: error.message,
          stack: error.stack
        });
      }
    });

    // API Service - using 127.0.0.1 for consistent IPv4 resolution
    const API_BASE_URL = 'http://127.0.0.1:8080/api';

    const apiService = {
      async request(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;

        const defaultOptions = {
          headers: {
            'Content-Type': 'application/json',
          },
        };

        const config = {
          ...defaultOptions,
          ...options,
          headers: {
            ...defaultOptions.headers,
            ...options.headers,
          },
        };

        try {
          console.log(`ðŸŒ API Request: ${config.method || 'GET'} ${url}`);
          console.log('ðŸ“¤ Request config:', JSON.stringify(config, null, 2));
          console.log('ðŸŒ Current origin:', window.location.origin);
          console.log('ðŸŽ¯ Target URL:', url);
          console.log('ðŸ”§ Browser info:', navigator.userAgent);

          // Add timing for debugging
          const startTime = performance.now();

          // Test basic connectivity first for POST requests
          if (config.method === 'POST') {
            console.log('ðŸ§ª Testing CORS preflight...');
            try {
              const preflightResponse = await fetch(url, {
                method: 'OPTIONS',
                headers: {
                  'Origin': window.location.origin,
                  'Access-Control-Request-Method': 'POST',
                  'Access-Control-Request-Headers': 'Content-Type'
                }
              });
              console.log('âœ… CORS preflight response:', preflightResponse.status, preflightResponse.statusText);
              console.log('ðŸ“‹ CORS headers:', Object.fromEntries(preflightResponse.headers.entries()));
            } catch (preflightError) {
              console.error('âŒ CORS preflight failed:', preflightError);
            }
          }

          const response = await fetch(url, config);

          const endTime = performance.now();
          console.log(`â±ï¸ Request took ${(endTime - startTime).toFixed(2)}ms`);
          console.log('ðŸ“¥ Response status:', response.status, response.statusText);
          console.log('ðŸ“‹ Response headers:', Object.fromEntries(response.headers.entries()));

          if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ HTTP Error Response:', errorText);
            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
          }

          const data = await response.json();
          console.log('âœ… API Response:', data);

          return data;
        } catch (error) {
          console.error('âŒ API Error:', error);
          console.error('âŒ Error details:', {
            name: error.name,
            message: error.message,
            stack: error.stack,
            url: url,
            method: config.method || 'GET',
            timestamp: new Date().toISOString()
          });

          // Enhanced error detection with specific debugging
          if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            console.error('ðŸš« Network Error: Failed to fetch - this indicates a network-level issue');
            console.error('ðŸ” Detailed diagnosis:');
            console.error('   1. API server status: Check if running on port 8080');
            console.error('   2. CORS configuration: Verify server allows origin', window.location.origin);
            console.error('   3. Network connectivity: Check if localhost:8080 is accessible');
            console.error('   4. Browser security: Check for mixed content or security policy blocks');
            console.error('   5. Firewall/Proxy: Check if connection is being blocked');

            // Additional connectivity tests
            console.log('ðŸ§ª Running additional diagnostics...');

            // Test if we can reach the server at all
            try {
              const basicTest = await fetch('http://127.0.0.1:8080/api/health', {
                method: 'GET',
                mode: 'cors'
              });
              console.log('âœ… Basic server connectivity test passed:', basicTest.status);
            } catch (basicError) {
              console.error('âŒ Basic server connectivity test failed:', basicError);
              console.error('   â†’ This confirms the server is not reachable from the browser');
            }
          }

          throw error;
        }
      },

      async testConnection() {
        return this.request('/chat/test');
      },

      async sendChatMessage(message, options = {}) {
        const payload = {
          message: message.trim(),
          timestamp: Date.now(),
          client: 'ichat-ui',
          use_rag: options.useRag || false,
          session_id: options.sessionId || `web-session-${Date.now()}`,
          conversation_id: options.conversationId || null,
          ...options
        };

        return this.request('/chat', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
      }
    };

    // Message Component
    const Message = ({ message }) => {
      const isUser = message.sender === 'user';
      const isAssistant = message.sender === 'assistant';

      const formatTime = (timestamp) => {
        return new Date(timestamp).toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        });
      };

      if (isUser) {
        return (
          <div className="w-full bg-gray-50 border-b border-gray-100">
            <div className="max-w-4xl mx-auto px-4 py-6">
              <div className="flex gap-4">
                <div className="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center flex-shrink-0">
                  <i className="fas fa-user text-white text-xs"></i>
                </div>
                <div className="flex-1 min-w-0">
                  <div className="text-gray-800 text-base leading-relaxed">
                    {message.text}
                  </div>
                  <div className="text-xs text-gray-500 mt-2">
                    {formatTime(message.timestamp)}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (isAssistant) {
        return (
          <div className="w-full bg-white border-b border-gray-100">
            <div className="max-w-4xl mx-auto px-4 py-6">
              <div className="flex gap-4">
                <div className="w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 flex items-center justify-center flex-shrink-0">
                  <i className="fas fa-robot text-white text-xs"></i>
                </div>
                <div className="flex-1 min-w-0">
                  <div className="text-gray-800 text-base leading-relaxed whitespace-pre-wrap">
                    {message.text}
                  </div>
                  <div className="text-xs text-gray-500 mt-2">
                    {formatTime(message.timestamp)}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="w-full bg-gray-50 border-b border-gray-100">
          <div className="max-w-4xl mx-auto px-4 py-3">
            <div className="flex justify-center">
              <div className="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs">
                {message.text}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // TypingIndicator Component
    const TypingIndicator = () => {
      return (
        <div className="w-full bg-white border-b border-gray-100">
          <div className="max-w-4xl mx-auto px-4 py-6">
            <div className="flex gap-4">
              <div className="w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 flex items-center justify-center flex-shrink-0">
                <i className="fas fa-robot text-white text-xs"></i>
              </div>
              <div className="flex-1 min-w-0">
                <div className="flex items-center space-x-2">
                  <div className="flex space-x-1">
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                  </div>
                  <span className="text-sm text-gray-500">Assistant is typing...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ChatInput Component
    const ChatInput = ({ onSend, disabled = false }) => {
      const [input, setInput] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (input.trim() && !disabled) {
          onSend(input.trim());
          setInput('');
        }
      };

      const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSubmit(e);
        }
      };

      return (
        <form onSubmit={handleSubmit} className="flex gap-2">
          <div className="flex-1 relative">
            <textarea
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder={disabled ? "Connecting to server..." : "Type your message..."}
              disabled={disabled}
              className={`w-full p-3 pr-12 rounded-xl border resize-none transition-colors ${
                disabled
                  ? 'bg-gray-100 border-gray-300 text-gray-400 cursor-not-allowed'
                  : 'bg-white border-gray-300 text-gray-800 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100'
              }`}
              rows="1"
              style={{ minHeight: '48px', maxHeight: '120px' }}
            />
            <button
              type="submit"
              disabled={!input.trim() || disabled}
              className={`absolute right-2 top-1/2 transform -translate-y-1/2 p-2 rounded-lg transition-colors ${
                !input.trim() || disabled
                  ? 'text-gray-400 cursor-not-allowed'
                  : 'text-blue-500 hover:text-blue-600 hover:bg-blue-50'
              }`}
            >
              <i className="fas fa-paper-plane"></i>
            </button>
          </div>
        </form>
      );
    };

    // ChatHeader Component
    const ChatHeader = ({ connectionStatus }) => {
      const getStatusColor = () => {
        switch (connectionStatus) {
          case 'connected': return 'text-green-400';
          case 'disconnected': return 'text-red-400';
          case 'checking': return 'text-yellow-400';
          default: return 'text-gray-500';
        }
      };

      const getStatusText = () => {
        switch (connectionStatus) {
          case 'connected': return 'Connected to API';
          case 'disconnected': return 'API Disconnected';
          case 'checking': return 'Checking connection...';
          default: return 'Unknown status';
        }
      };

      const getStatusIcon = () => {
        switch (connectionStatus) {
          case 'connected': return 'fa-circle';
          case 'disconnected': return 'fa-times-circle';
          case 'checking': return 'fa-clock';
          default: return 'fa-question-circle';
        }
      };

      return (
        <div className="bg-white border-b border-gray-200 p-3 shadow-sm">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 flex items-center justify-center">
                <i className="fas fa-comments text-white text-sm"></i>
              </div>
              <div>
                <h1 className="text-lg font-bold gradient-text">
                  iChat Assistant
                </h1>
                <p className={`text-xs ${getStatusColor()}`}>
                  <i className={`fas ${getStatusIcon()} text-xs mr-1 ${connectionStatus === 'connected' ? 'animate-pulse' : ''}`}></i>
                  {getStatusText()}
                </p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={async () => {
                  console.log('ðŸ”¬ Running comprehensive API diagnostics...');

                  const results = {
                    basicConnectivity: null,
                    corsPreflightTest: null,
                    getEndpointTest: null,
                    postEndpointTest: null,
                    healthCheck: null
                  };

                  try {
                    // Test 1: Basic connectivity to health endpoint
                    console.log('ðŸ§ª Test 1: Basic health check...');
                    try {
                      const healthResponse = await fetch('http://127.0.0.1:8080/api/health', {
                        method: 'GET',
                        mode: 'cors'
                      });
                      results.healthCheck = {
                        status: healthResponse.status,
                        statusText: healthResponse.statusText,
                        headers: Object.fromEntries(healthResponse.headers.entries())
                      };
                      console.log('âœ… Health check passed:', results.healthCheck);
                    } catch (error) {
                      results.healthCheck = { error: error.message };
                      console.error('âŒ Health check failed:', error);
                    }

                    // Test 2: CORS preflight test
                    console.log('ðŸ§ª Test 2: CORS preflight test...');
                    try {
                      const preflightResponse = await fetch('http://127.0.0.1:8080/api/chat', {
                        method: 'OPTIONS',
                        headers: {
                          'Origin': window.location.origin,
                          'Access-Control-Request-Method': 'POST',
                          'Access-Control-Request-Headers': 'Content-Type'
                        }
                      });
                      results.corsPreflightTest = {
                        status: preflightResponse.status,
                        statusText: preflightResponse.statusText,
                        headers: Object.fromEntries(preflightResponse.headers.entries())
                      };
                      console.log('âœ… CORS preflight passed:', results.corsPreflightTest);
                    } catch (error) {
                      results.corsPreflightTest = { error: error.message };
                      console.error('âŒ CORS preflight failed:', error);
                    }

                    // Test 3: GET endpoint test
                    console.log('ðŸ§ª Test 3: GET endpoint test...');
                    try {
                      const getResult = await apiService.testConnection();
                      results.getEndpointTest = { success: true, data: getResult };
                      console.log('âœ… GET endpoint test passed:', getResult);
                    } catch (error) {
                      results.getEndpointTest = { error: error.message };
                      console.error('âŒ GET endpoint test failed:', error);
                    }

                    // Test 4: POST endpoint test
                    console.log('ðŸ§ª Test 4: POST endpoint test...');
                    try {
                      const postResult = await apiService.sendChatMessage('Diagnostic test message');
                      results.postEndpointTest = { success: true, data: postResult };
                      console.log('âœ… POST endpoint test passed:', postResult);
                    } catch (error) {
                      results.postEndpointTest = { error: error.message };
                      console.error('âŒ POST endpoint test failed:', error);
                    }

                    // Display comprehensive results
                    const successCount = Object.values(results).filter(r => r && (r.success || r.status === 200)).length;
                    const totalTests = Object.keys(results).length;

                    console.log('ðŸ“Š Diagnostic Results Summary:', results);

                    const resultText = `ðŸ”¬ API Diagnostics Complete (${successCount}/${totalTests} passed)\n\n` +
                      `Health Check: ${results.healthCheck?.status || 'Failed'}\n` +
                      `CORS Preflight: ${results.corsPreflightTest?.status || 'Failed'}\n` +
                      `GET Endpoint: ${results.getEndpointTest?.success ? 'Passed' : 'Failed'}\n` +
                      `POST Endpoint: ${results.postEndpointTest?.success ? 'Passed' : 'Failed'}\n\n` +
                      `Check browser console for detailed logs.`;

                    alert(resultText);

                  } catch (error) {
                    console.error('âŒ Diagnostics failed:', error);
                    alert('âŒ Diagnostics Failed!\n\nError: ' + error.message);
                  }
                }}
                className="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors"
              >
                ðŸ”¬ Diagnose
              </button>
              <button className="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-center">
                <i className="fas fa-ellipsis-v text-gray-600"></i>
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Sidebar Component
    const Sidebar = ({ activeSection, setActiveSection }) => {
      const [isOpen, setIsOpen] = useState(true);

      const menuItems = [
        {
          id: 'chat',
          name: 'Chat',
          icon: 'fas fa-comments',
          description: 'AI Chat Assistant'
        },
        {
          id: 'mcp',
          name: 'MCP Connection',
          icon: 'fas fa-plug',
          description: 'Model Context Protocol'
        },
        {
          id: 'context',
          name: 'Context Setup',
          icon: 'fas fa-cog',
          description: 'Repository Context'
        }
      ];

      const toggleSidebar = () => {
        setIsOpen(!isOpen);
      };

      const handleItemClick = (itemId) => {
        setActiveSection(itemId);
      };

      return (
        <div className={`bg-white border-r border-gray-200 shadow-lg transition-all duration-300 flex flex-col h-full ${
          isOpen ? 'w-64' : 'w-16'
        }`}>
          {/* Fixed Header */}
          <div className="flex-shrink-0 p-4 border-b border-gray-200">
            <div className="flex items-center justify-between">
              {isOpen && (
                <h2 className="text-lg font-semibold text-gray-800">iChat</h2>
              )}
              <button
                onClick={toggleSidebar}
                className="p-2 rounded-lg hover:bg-gray-100 transition-colors"
              >
                <i className={`fas ${isOpen ? 'fa-chevron-left' : 'fa-chevron-right'} text-gray-500`}></i>
              </button>
            </div>
          </div>

          {/* Scrollable Navigation */}
          <nav className="flex-1 p-2 overflow-y-auto">
            {menuItems.map((item) => (
              <button
                key={item.id}
                onClick={() => handleItemClick(item.id)}
                className={`w-full flex items-center gap-3 p-3 rounded-lg transition-colors mb-2 ${
                  activeSection === item.id
                    ? 'bg-blue-500 text-white shadow-md'
                    : 'text-gray-600 hover:bg-gray-100 hover:text-gray-800'
                }`}
              >
                <i className={`${item.icon} text-lg`}></i>
                {isOpen && (
                  <div className="flex-1 text-left">
                    <div className="font-medium">{item.name}</div>
                    <div className="text-xs opacity-75">{item.description}</div>
                  </div>
                )}
              </button>
            ))}
          </nav>

          {/* Fixed Footer */}
          {isOpen && (
            <div className="flex-shrink-0 p-4 border-t border-gray-200">
              <div className="text-xs text-gray-500">
                <div>iChat Assistant v2.0</div>
                <div>Powered by AI</div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // ChatContent Component
    const ChatContent = ({ messages, isTyping, onSend, connectionStatus }) => {
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages, isTyping]);

      return (
        <div className="flex-1 flex flex-col h-screen">
          {/* Fixed Header */}
          <div className="flex-shrink-0">
            <ChatHeader connectionStatus={connectionStatus} />
          </div>

          {/* Scrollable Messages Area */}
          <div className="flex-1 overflow-y-auto min-h-0">
            {messages.map((message) => (
              <Message key={message.id} message={message} />
            ))}

            {isTyping && <TypingIndicator />}

            <div ref={messagesEndRef} />
          </div>

          {/* Fixed Input Area */}
          <div className="flex-shrink-0 border-t border-gray-200 bg-white">
            <div className="max-w-4xl mx-auto px-4 py-4">
              <ChatInput onSend={onSend} disabled={connectionStatus === 'disconnected'} />
            </div>
          </div>
        </div>
      );
    };

    // MCPContent Component
    const MCPContent = () => {
      const providers = [
        {
          id: 'database',
          name: 'Database',
          icon: 'fas fa-database',
          description: 'Connect to SQL databases',
          status: 'available'
        },
        {
          id: 'filesystem',
          name: 'File System',
          icon: 'fas fa-folder',
          description: 'Access local file system',
          status: 'available'
        },
        {
          id: 'api',
          name: 'API Services',
          icon: 'fas fa-cloud',
          description: 'Connect to external APIs',
          status: 'available'
        }
      ];

      return (
        <div className="flex-1 flex flex-col">
          <div className="bg-white border-b border-gray-200 p-4 shadow-sm">
            <h1 className="text-xl font-bold text-gray-800">MCP Connection</h1>
            <p className="text-sm text-gray-600">Configure Model Context Protocol providers</p>
          </div>

          <div className="flex-1 p-6">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {providers.map((provider) => (
                <div key={provider.id} className="bg-white rounded-lg p-4 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                  <div className="flex items-center gap-3 mb-3">
                    <div className="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center">
                      <i className={`${provider.icon} text-gray-600`}></i>
                    </div>
                    <div>
                      <h3 className="font-semibold text-gray-800">{provider.name}</h3>
                      <p className="text-xs text-gray-600">{provider.description}</p>
                    </div>
                  </div>
                  <button className="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    Connect
                  </button>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ContextContent Component
    const ContextContent = () => {
      const [repoUrl, setRepoUrl] = useState('');
      const [accessToken, setAccessToken] = useState('');

      const handleConnect = (e) => {
        e.preventDefault();
        console.log('Connecting to repository:', { repoUrl, accessToken });
      };

      return (
        <div className="flex-1 flex flex-col">
          <div className="bg-white border-b border-gray-200 p-4 shadow-sm">
            <h1 className="text-xl font-bold text-gray-800">Context Setup</h1>
            <p className="text-sm text-gray-600">Connect your code repositories for enhanced AI assistance</p>
          </div>

          <div className="flex-1 p-6">
            <div className="max-w-md mx-auto">
              <form onSubmit={handleConnect} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Repository URL
                  </label>
                  <input
                    type="url"
                    value={repoUrl}
                    onChange={(e) => setRepoUrl(e.target.value)}
                    placeholder="https://github.com/username/repository"
                    className="w-full p-3 bg-white border border-gray-300 rounded-lg text-gray-800 placeholder-gray-400 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Access Token
                  </label>
                  <input
                    type="password"
                    value={accessToken}
                    onChange={(e) => setAccessToken(e.target.value)}
                    placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                    className="w-full p-3 bg-white border border-gray-300 rounded-lg text-gray-800 placeholder-gray-400 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100"
                    required
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Generate a personal access token from your repository settings
                  </p>
                </div>

                <button
                  type="submit"
                  className="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium"
                >
                  Connect Repository
                </button>
              </form>

              <div className="mt-8">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">Connected Repositories</h3>
                <div className="text-center text-gray-500 py-8">
                  <i className="fas fa-code-branch text-4xl mb-4"></i>
                  <p>No repositories connected yet</p>
                  <p className="text-sm">Connect your first repository to get started</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Main App Component
    const App = () => {
      const [messages, setMessages] = useState([
        {
          id: 1,
          text: "Hello! I'm your iChat Assistant. How can I help you today?",
          sender: 'assistant',
          timestamp: new Date()
        }
      ]);

      const [isTyping, setIsTyping] = useState(false);
      const [activeSection, setActiveSection] = useState('chat');
      const [connectionStatus, setConnectionStatus] = useState('checking');

      // Check API connectivity on component mount
      useEffect(() => {
        const checkConnection = async () => {
          try {
            console.log('ðŸ” Checking API connection...');
            const response = await apiService.testConnection();
            console.log('ðŸ“¡ Connection test response:', response);
            if (response && response.status === 'success') {
              console.log('âœ… API connection successful');
              setConnectionStatus('connected');
            } else {
              console.log('âŒ API connection failed - invalid response');
              setConnectionStatus('disconnected');
            }
          } catch (error) {
            console.error('âŒ Connection check failed:', error);
            setConnectionStatus('disconnected');
          }
        };

        // Add a small delay to ensure API server is ready
        setTimeout(() => {
          checkConnection();
        }, 1000);

        const interval = setInterval(checkConnection, 30000);
        return () => clearInterval(interval);
      }, []);

      const handleSend = async (text) => {
        const userMessage = {
          id: Date.now(),
          text,
          sender: 'user',
          timestamp: new Date()
        };

        setMessages(prev => [...prev, userMessage]);
        setIsTyping(true);

        try {
          const response = await apiService.sendChatMessage(text, {
            useRag: false,
            sessionId: `web-session-${Date.now()}`
          });

          if (response.status === 'success') {
            setConnectionStatus('connected');

            const assistantMessage = {
              id: Date.now() + 1,
              text: response.response || response.message || 'I received your message but had trouble generating a response.',
              sender: 'assistant',
              timestamp: new Date()
            };

            setMessages(prev => [...prev, assistantMessage]);
          } else {
            const errorMessage = {
              id: Date.now() + 1,
              text: `Sorry, I encountered an error: ${response.error || 'Unknown error occurred'}`,
              sender: 'assistant',
              timestamp: new Date()
            };

            setMessages(prev => [...prev, errorMessage]);
          }
        } catch (error) {
          console.error('Chat API Error:', error);
          setConnectionStatus('disconnected');

          const errorMessage = {
            id: Date.now() + 1,
            text: `Sorry, I'm having trouble connecting to the server. Please check if the API server is running on port 8080. Error: ${error.message}`,
            sender: 'assistant',
            timestamp: new Date()
          };

          setMessages(prev => [...prev, errorMessage]);
        } finally {
          setIsTyping(false);
        }
      };

      const renderContent = () => {
        switch (activeSection) {
          case 'chat':
            return (
              <ChatContent
                messages={messages}
                isTyping={isTyping}
                onSend={handleSend}
                connectionStatus={connectionStatus}
              />
            );
          case 'mcp':
            return <MCPContent />;
          case 'context':
            return <ContextContent />;
          default:
            return (
              <ChatContent
                messages={messages}
                isTyping={isTyping}
                onSend={handleSend}
                connectionStatus={connectionStatus}
              />
            );
        }
      };

      return (
        <div className="h-screen bg-gray-50 text-gray-800 flex overflow-hidden">
          <Sidebar
            activeSection={activeSection}
            setActiveSection={setActiveSection}
          />
          {renderContent()}
        </div>
      );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
</body>
</html>

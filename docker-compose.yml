version: '3.8'

services:
  # iChat UI Frontend
  ichat-ui:
    build:
      context: ./ichat-ui
      dockerfile: Dockerfile
    container_name: ichat-ui-frontend
    ports:
      - "3001:80"
    environment:
      - NGINX_HOST=localhost
      - NGINX_PORT=80
      - API_BASE_URL=http://localhost:8080
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    depends_on:
      - ichat-api

  # News Automation Frontend
  news-automation-frontend:
    build:
      context: ./frontend-server
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    container_name: news-automation-frontend
    ports:
      - "3002:3002"  # Express API proxy
      - "3003:80"    # Nginx static files (optional)
    environment:
      # Server Configuration
      - NODE_ENV=production
      - PORT=3002

      # API Server URLs (Docker internal network)
      - API_SERVER_URL=http://ichat-api-server:8080
      - NEWS_FETCHER_URL=http://ichat-news-fetcher:8093
      - IOPAINT_URL=http://ichat-iopaint:8096
      - YOUTUBE_UPLOADER_URL=http://ichat-youtube-uploader:8097
      - VOICE_GENERATOR_URL=http://ichat-voice-generator:8094
      - AUDIO_GENERATION_URL=http://audio-generation-factory:3000

      # Frontend Configuration
      - VITE_API_BASE_URL=/api
      - VITE_WS_URL=ws://localhost:3002

      # Logging
      - LOG_LEVEL=info
      - LOG_FORMAT=json

      # Security
      - CORS_ORIGIN=http://localhost:3002,http://localhost:3003

      # Performance
      - MAX_REQUEST_SIZE=100mb
      - REQUEST_TIMEOUT=300000
    volumes:
      # Logs persistence
      - ./frontend-server/logs:/app/logs
      # Data persistence (optional)
      - ./frontend-server/data:/app/data
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD-SHELL", "node -e \"require('http').get('http://localhost:3002/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\"" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    depends_on:
      ichat-api:
        condition: service_healthy
      job-news-fetcher:
        condition: service_started
      iopaint:
        condition: service_started
      youtube-uploader:
        condition: service_started
    labels:
      - "com.news-automation.service=frontend"
      - "com.news-automation.version=1.0.0"
      - "com.news-automation.description=News Automation Frontend Server"

  # Main iChat API Server
  ichat-api:
    build:
      context: ./api-server
      dockerfile: Dockerfile
    container_name: ichat-api-server
    ports:
      - "8080:8080"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8080
      - MCP_SERVICE_HOST=ichat-mcp-service
      - MCP_SERVICE_PORT=8089
      - CODE_GENERATION_SERVICE_HOST=ichat-code-generation-service
      - CODE_GENERATION_SERVICE_PORT=8088
      - LLM_SERVICE_HOST=ichat-llm-service
      - LLM_SERVICE_PORT=8083
      - LLM_SERVICE_URL=http://ichat-llm-service:8083
      - LOG_LEVEL=DEBUG
      # JWT Configuration (must match auth-service)
      - JWT_SECRET_KEY=your-super-secret-jwt-key-change-in-production-2024
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION_HOURS=24
      # MongoDB Configuration
      - MONGODB_HOST=ichat-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=ichat_db
      - MONGODB_USERNAME=ichat_app
      - MONGODB_PASSWORD=ichat_app_password_2024
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/ichat_db
    volumes:
      - ./api-server/logs:/app/logs
      - ./api-server/data:/app/data
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    depends_on:
      - ichat-mongodb

  # OCR Document Converter Service
  ocr-service:
    build:
      context: ./ocr-service
      dockerfile: Dockerfile
    container_name: ichat-ocr-service
    ports:
      - "8081:8081"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8081
      - OCR_DEFAULT_LANGUAGE=en
      - OCR_USE_GPU=false
      - MAX_FILE_SIZE=10485760  # 10MB
    volumes:
      - ./ocr-service/uploads:/app/uploads
      - ./ocr-service/outputs:/app/outputs
      - ./ocr-service/logs:/app/logs
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # OCR service takes longer to start
    restart: unless-stopped
    depends_on:
      - ichat-api

  # LLM Service for AI responses
  llm-service:
    build:
      context: ./llm/llm-prompt-generation
      dockerfile: Dockerfile
    container_name: ichat-llm-service
    ports:
      - "8083:8083"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8083
      - LLM_HOST=0.0.0.0
      - LLM_PORT=8083
      # Model Configuration - Change LLM_MODEL_KEY to select different models
      # Options: flan-t5-base, flan-t5-small, flan-t5-large, mistral-7b-q4, mistral-7b-q5, mistral-7b-q2, mt5-small-hindi, mt5-base-hindi, aya-8b-multilingual
      # Using Mistral 7B Instruct Q4_K_M - High-quality quantized model for efficient inference
      - LLM_MODEL_KEY=mistral-7b-q4
      - LLM_MODEL_NAME=mistral-7b-instruct-v0.2.Q4_K_M.gguf
      - MODEL_TYPE=mistral
      - MODEL_FILE=mistral-7b-instruct-v0.2.Q4_K_M.gguf
      - LLM_USE_GPU=false
      - MODEL_CACHE_DIR=/app/cache
      - RETRIEVER_SERVICE_URL=http://ichat-retriever-service:8086
      # Hugging Face Authentication
      - HUGGINGFACE_HUB_TOKEN=${HUGGINGFACE_HUB_TOKEN}
      # Context Window Configuration
      - N_CTX=4096
      - N_BATCH=512
      - LLM_MAX_NEW_TOKENS=2048
      - ENABLE_CONTINUATION=true
      - SLIDING_WINDOW_TOKENS=300
      # Streaming Configuration
      - STREAM_DELAY_MS=100
      - MIN_SIMILARITY_THRESHOLD=0.5
      - RETRIEVER_TIMEOUT=300
      - MODEL_LOAD_TIMEOUT=300
      - MAX_CONTEXT_LENGTH=4000
      - ENABLE_STREAMING=true
      - STREAM_DELAY_MS=50
      # Sliding Window Continuation Configuration
      - ENABLE_CONTINUATION=true
      - MAX_CONTINUATION_LOOPS=5
      - SLIDING_WINDOW_TOKENS=300
      - CONTINUATION_THRESHOLD=0.9
    volumes:
      - ./llm/llm-prompt-generation/logs:/app/logs
      - llm-model-cache:/app/cache  # Use named volume for persistent model cache
    networks:
      - ichat-network
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 6G
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8083/health" ]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 180s  # LLM service takes longer to load model
    restart: unless-stopped
    depends_on:
      - ichat-api

  # Embedding Service for document processing
  embedding-service:
    build:
      context: ./llm/embedding-service
      dockerfile: Dockerfile
    container_name: ichat-embedding-service
    ports:
      - "8085:8085"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8085
      - OCR_SERVICE_URL=http://ichat-ocr-service:8081
      - VECTOR_DB_URL=http://ichat-vector-db:8084
      - REQUEST_TIMEOUT=300
      - OCR_TIMEOUT=300
      - VECTOR_DB_TIMEOUT=300
      - LOG_LEVEL=DEBUG
      # Token-based chunking configuration
      - CHUNK_SIZE=1024
      - CHUNK_OVERLAP=200
      - MIN_CHUNK_SIZE=100
      # Search configuration
      - DEFAULT_SEARCH_LIMIT=100
      - MIN_SIMILARITY_THRESHOLD=0.5
    volumes:
      - ./llm/embedding-service/logs:/app/logs
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8085/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      - ocr-service
      - ichat-vector-db

  # Vector Database Service
  ichat-vector-db:
    build:
      context: ./llm/vector-db
      dockerfile: Dockerfile
    container_name: ichat-vector-db
    ports:
      - "8084:8084"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8084
      - CHROMA_DB_PATH=/app/data/chroma
    volumes:
      - ./llm/vector-db/data:/app/data
      - ./llm/vector-db/logs:/app/logs
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8084/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # Retriever Service for RAG
  ichat-retriever-service:
    build:
      context: ./llm/retriever-service
      dockerfile: Dockerfile
    container_name: ichat-retriever-service
    ports:
      - "8086:8086"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8086
      - VECTOR_DB_URL=http://ichat-vector-db:8084
      - EMBEDDING_SERVICE_URL=http://ichat-embedding-service:8085
      - EMBEDDING_TIMEOUT=300
      - VECTOR_DB_TIMEOUT=300
      - LOG_LEVEL=DEBUG
      # Search Configuration
      - DEFAULT_SEARCH_LIMIT=100
      - MAX_SEARCH_LIMIT=100
      - EMBEDDING_SEARCH_LIMIT=100
      - MIN_SIMILARITY_THRESHOLD=0.5
      # Context Configuration (characters)
      - CONTEXT_WINDOW_SIZE=10000
      - MAX_CONTEXT_CHUNKS=3
      # Reranking Configuration
      - ENABLE_RERANKING=true
      - RERANKER_MODEL=cross-encoder/ms-marco-MiniLM-L-6-v2
      - RERANKER_BATCH_SIZE=32
      - RERANKER_MAX_WORKERS=4
      - RERANKER_TIMEOUT=30
    volumes:
      - ./llm/retriever-service/logs:/app/logs
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8086/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    depends_on:
      - ichat-vector-db
      - embedding-service

  # Code Generation Service
  ichat-code-generation-service:
    build:
      context: ./code-generation-service
      dockerfile: Dockerfile
    container_name: ichat-code-generation-service
    ports:
      - "8088:8088"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8088
      - LLM_SERVICE_HOST=ichat-llm-service
      - LLM_SERVICE_PORT=8083
      - LLM_PROMPT_SERVICE_HOST=ichat-llm-service
      - LLM_PROMPT_SERVICE_PORT=8083
      - EMBEDDING_SERVICE_HOST=ichat-embedding-service
      - EMBEDDING_SERVICE_PORT=8085
      - MAX_REPO_SIZE_MB=500
      - MAX_FILE_SIZE_KB=1024
      - LOG_LEVEL=INFO
      - ANALYSIS_TIMEOUT=300
      - CODE_GENERATION_TIMEOUT=300
      - HTTP_TIMEOUT=300
      - LLM_REQUEST_TIMEOUT=300
      - RAG_SYNC_THREADS=10
      - RAG_SYNC_BATCH_SIZE=5
    volumes:
      - ./code-generation-service/logs:/app/logs
      - ./code-generation-service/temp:/app/temp
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8088/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    depends_on:
      - llm-service
      - embedding-service

  # MCP Service for Model Context Protocol integration
  ichat-mcp-service:
    build:
      context: ./mcp-service
      dockerfile: Dockerfile
    container_name: ichat-mcp-service
    ports:
      - "8089:8089"
    environment:
      - FLASK_ENV=production
      - FLASK_DEBUG=false
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8089
      - MAX_MCP_CONNECTIONS=10
      - MCP_CONNECTION_TIMEOUT=300
      - MCP_EXECUTION_TIMEOUT=300
      - MCP_CONFIG_STORAGE_PATH=/app/data/mcp_configs
      - MCP_TEMP_PATH=/app/temp
      - OAUTH_STATE_EXPIRY=600
      - LOG_LEVEL=INFO
      # MongoDB Configuration
      - MONGODB_HOST=ichat-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=ichat_db
      - MONGODB_USERNAME=ichat_app
      - MONGODB_PASSWORD=ichat_app_password_2024
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/ichat_db
    volumes:
      - ./mcp-service/logs:/app/logs
      - ./mcp-service/data:/app/data
      - ./mcp-service/temp:/app/temp
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8089/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    depends_on:
      - ichat-mongodb

  # Remote Host Syncer Job for Document Synchronization
  job-remote-host-syncer:
    build:
      context: ./jobs/remote-host-syncer
      dockerfile: Dockerfile
    container_name: job-remote-host-syncer
    ports:
      - "8091:8091"
    environment:
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8091
      - DOCKER_ENV=true
      - MCP_SERVICE_URL=http://ichat-mcp-service:8089
      - API_SERVER_URL=http://ichat-api-server:8080
      - EMBEDDING_SERVICE_URL=http://ichat-embedding-service:8085
      - SYNC_FREQUENCY=daily
      - SYNC_TIME=02:00
      - MAX_FILE_SIZE_MB=50
      - BATCH_SIZE=100
      - MAX_CONCURRENT_CONNECTIONS=3
      - MAX_RETRIES=3
      - RETRY_DELAY_SECONDS=5
      - LOG_LEVEL=INFO
      - SUPPORTED_EXTENSIONS=.txt,.md,.py,.js,.java,.cpp,.c,.h,.json,.xml,.yaml,.yml,.csv,.log
      - RUN_INITIAL_SYNC=false
      - AUTO_RESTART_INTERRUPTED_JOBS=false
      - HEALTH_CHECK_PORT=8091
      - DB_PATH=data/syncer.db
      - LOG_FILE=logs/remote-host-syncer.log
      # MongoDB Configuration
      - MONGODB_HOST=ichat-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=ichat_db
      - MONGODB_USERNAME=ichat_app
      - MONGODB_PASSWORD=ichat_app_password_2024
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/ichat_db
    volumes:
      - ./jobs/remote-host-syncer/data:/app/data
      - ./jobs/remote-host-syncer/logs:/app/logs
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8091/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    depends_on:
      - ichat-mcp-service
      - ichat-api
      - embedding-service
      - ichat-mongodb

  # GitHub Repository Syncer Job for Repository Synchronization
  job-github-repo-syncer:
    build:
      context: ./jobs/github-repo-syncer
      dockerfile: Dockerfile
    container_name: job-github-repo-syncer
    ports:
      - "8092:8092"
    environment:
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8092
      - DOCKER_ENV=true
      - MCP_SERVICE_URL=http://ichat-mcp-service:8089
      - API_SERVER_URL=http://ichat-api-server:8080
      - EMBEDDING_SERVICE_URL=http://ichat-embedding-service:8085
      - SYNC_FREQUENCY=daily
      - SYNC_TIME=03:00
      - MAX_FILE_SIZE_MB=10
      - BATCH_SIZE=50
      - MAX_CONCURRENT_REPOSITORIES=2
      - MAX_RETRIES=3
      - RETRY_DELAY_SECONDS=5
      - LOG_LEVEL=INFO
      - CLONE_DEPTH=1
      - REQUEST_TIMEOUT=30
      - GITHUB_API_TIMEOUT=30
      - RUN_INITIAL_SYNC=false
      - AUTO_RESTART_INTERRUPTED_JOBS=false
      - HEALTH_CHECK_PORT=8092
      - DB_PATH=data/github_syncer.db
      - LOG_FILE=logs/github-repo-syncer.log
      # MongoDB Configuration
      - MONGODB_HOST=ichat-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=ichat_db
      - MONGODB_USERNAME=ichat_app
      - MONGODB_PASSWORD=ichat_app_password_2024
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/ichat_db
    volumes:
      - ./jobs/github-repo-syncer/data:/app/data
      - ./jobs/github-repo-syncer/logs:/app/logs
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8092/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    depends_on:
      - ichat-mcp-service
      - ichat-api
      - embedding-service
      - ichat-mongodb

  # News Fetcher Job Service
  job-news-fetcher:
    build:
      context: ./jobs
      dockerfile: news-fetcher/Dockerfile
    container_name: ichat-news-fetcher
    ports:
      - "8093:8093"
    environment:
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8093
      - FLASK_DEBUG=false
      - FLASK_ENV=production
      - JOB_INTERVAL_MINUTES=5
      - LOG_LEVEL=INFO
      - LOG_FILE=logs/news-fetcher.log
      # MongoDB Configuration
      - MONGODB_HOST=ichat-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=ichat_db
      - MONGODB_USERNAME=ichat_app
      - MONGODB_PASSWORD=ichat_app_password_2024
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/ichat_db?authSource=admin
      # News Database Configuration
      - NEWS_MONGODB_DATABASE=news
      - NEWS_MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/news?authSource=admin
      # News API Configuration
      - API_KEY=${GNEWS_API_KEY:-c01da20de0ad07ce5ab3b91a7603f7bb}
      - SUPPORTED_CATEGORY=general
      - DEFAULT_LANG=hi
      - DEFAULT_COUNTRY=in
      - HTTP_TIMEOUT=30
      - HTTP_RETRIES=3
      - MAX_ARTICLES_PER_FETCH=100
      # News API Configuration
      - DEFAULT_PAGE_SIZE=10
      - MAX_PAGE_SIZE=50
      # Default API Filter Values
      - DEFAULT_FILTER_CATEGORY=general
      - DEFAULT_FILTER_LANGUAGE=en
      - DEFAULT_FILTER_COUNTRY=in
    volumes:
      - ./jobs/news-fetcher/logs:/app/logs
      - ./jobs/news-fetcher/data:/app/data
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8093/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    depends_on:
      - ichat-mongodb

  # Voice Generator Job Service
  job-voice-generator:
    build:
      context: ./jobs
      dockerfile: voice-generator/Dockerfile
    container_name: ichat-voice-generator
    ports:
      - "8094:8094"
    # Memory and resource limits to prevent crashes
    #    deploy:
    #      resources:
    #        limits:
    #          memory: 8G        # Limit to 8GB RAM
    #          cpus: '2.0'       # Limit to 2 CPU cores
    #        reservations:
    #          memory: 4G        # Reserve 4GB RAM
    #          cpus: '1.0'       # Reserve 1 CPU core
    # Enable swap to prevent OOM kills
    #    mem_swappiness: 60      # Allow moderate swapping
    #    shm_size: 1G            # Shared memory for PyTorch
    environment:
      # Basic Configuration
      - DEBUG=false
      - HOST=0.0.0.0
      - PORT=8094
      # Job Configuration
      - JOB_FREQUENCY_MINUTES=5
      - MAX_THREADS=1
      - MAX_PARALLEL_TASKS=2
      # Voice Service Configuration
      - AUDIO_GENERATION_SERVICE_URL=http://audio-generation-factory:3000
      - VOICE_SERVICE_TIMEOUT=10800
      - DEFAULT_LANGUAGE=en
      - AUDIO_BATCH_SIZE=25
      # Voice/Anchor Alternation Configuration
      - ENABLE_VOICE_ALTERNATION=true
      - MALE_VOICES=am_adam,am_michael
      - FEMALE_VOICES=af_bella,af_sarah
      - DEFAULT_MALE_VOICE=am_adam
      - DEFAULT_FEMALE_VOICE=af_bella
      # Chunking Configuration
      - ENABLE_CHUNKING=true
      - CHUNKING_THRESHOLD=300
      - MAX_CHUNK_LENGTH=200
      - MAX_WORKERS=10
      # File Storage Configuration
      - DATA_DIR=/app/data
      - MAX_FILE_SIZE_MB=50
      # Database Configuration
      - MONGODB_HOST=ichat-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=ichat_db
      - MONGODB_USERNAME=ichat_app
      - MONGODB_PASSWORD=ichat_app_password_2024
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/ichat_db?authSource=admin
      # News Database Configuration
      - NEWS_MONGODB_DATABASE=news
      - NEWS_MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/news?authSource=admin
      # Logging Configuration
      - LOG_LEVEL=INFO
      - LOG_FILE=logs/voice-generator.log
      - HEALTH_CHECK_PORT=8094
    volumes:
      - ./jobs/voice-generator/logs:/app/logs
      - ./jobs/voice-generator/data:/app/data
      # Shared volume with audio-generation-factory for TTS files (public directory)
      - ./audio-generation/public:/app/tts_data
      # Mount audio-generation public directory for generated audio files
      - ./audio-generation/public:/app/public
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8094/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      - ichat-mongodb
      - audio-generation-factory

  # Audio Generation Factory Service (MMS TTS)
  audio-generation-factory:
    build:
      context: ./audio-generation
      dockerfile: Dockerfile
    container_name: audio-generation-factory
    ports:
      - "3000:3000"
    volumes:
      # Host directory for model caching (persistent across rebuilds)
      - ./audio-generation/data:/app/data
      # Host directory for audio output (accessible from host)
      - ./audio-generation/public:/app/public
    environment:
      - NODE_ENV=production
      - PORT=3000
      - MODEL_CACHE_DIR=/app/data/models
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # TTS models take time to download and initialize
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'

  # Video Generator Job Service
  job-video-generator:
    build:
      context: ./jobs
      dockerfile: video-generator/Dockerfile
    container_name: ichat-video-generator
    ports:
      - "8095:8095"
    environment:
      # Basic Configuration
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8095
      - FLASK_DEBUG=false
      - FLASK_ENV=production
      - JOB_INTERVAL_MINUTES=5
      - LOG_LEVEL=INFO
      - LOG_FILE=logs/video-generator.log
      # MongoDB Configuration
      - MONGODB_HOST=ichat-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=ichat_db
      - MONGODB_USERNAME=ichat_app
      - MONGODB_PASSWORD=ichat_app_password_2024
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/ichat_db?authSource=admin
      # News Database Configuration
      - NEWS_MONGODB_DATABASE=news
      - NEWS_MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/news?authSource=admin
      # Video Generation Configuration
      - VIDEO_QUALITY=high
      - VIDEO_WIDTH=1920
      - VIDEO_HEIGHT=1080
      - VIDEO_FPS=30
      - BATCH_SIZE=25
      - PROCESSING_TIMEOUT=600
      - IMAGE_DOWNLOAD_TIMEOUT=30
      - MAX_IMAGE_SIZE_MB=10
      - MAX_THREADS=2
      - MAX_PARALLEL_TASKS=3
      # Text Overlay Configuration
      - TITLE_FONT_SIZE=48
      - DESCRIPTION_FONT_SIZE=24
      - TEXT_COLOR=white
      # Ken Burns Effect Configuration
      - ENABLE_KEN_BURNS=true
      - KEN_BURNS_ZOOM_START=1.0
      - KEN_BURNS_ZOOM_END=1.3
      - KEN_BURNS_EASING=ease_in_out
      # Fade Text Effect Configuration
      - ENABLE_FADE_TEXT=true
      - FADE_TEXT_IN_DURATION=0.5
      - FADE_TEXT_OUT_DURATION=0.5
      - FADE_TEXT_TYPE=both
      # Fade Text Effect Configuration
      - ENABLE_FADE_TEXT=true
      - FADE_TEXT_IN_DURATION=0.5
      - FADE_TEXT_OUT_DURATION=0.5
      - FADE_TEXT_TYPE=both
    volumes:
      - ./jobs/video-generator/logs:/app/logs
      - ./jobs/video-generator/public:/app/public
      - ./audio-generation/public:/app/audio_input:ro  # Read-only access to audio files
      - ./jobs/video-generator/temp:/app/temp
      - ./jobs/video-generator/subscribe:/app/subscribe:ro  # Read-only access to subscribe video template
      - ./jobs/video-generator/assets:/app/assets  # Persist uploaded background audio files
    networks:
      - ichat-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8095/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      - ichat-mongodb
      - job-voice-generator



  # IOPaint Logo/Watermark Removal Service with MongoDB Integration
  iopaint:
    build:
      context: ./jobs
      dockerfile: ./watermark-remover/Dockerfile
    container_name: ichat-iopaint
    ports:
      - "8096:8096"
    environment:
      - FLASK_PORT=8096
      - OUTPUT_DIR=/app/output
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/news?authSource=admin
    volumes:
      - ./jobs/watermark-remover/public:/app/output
      - ./jobs/watermark-remover/models:/root/.cache
    networks:
      - ichat-network
    depends_on:
      - ichat-mongodb
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8096/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Model loading takes time
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G

  # YouTube Uploader Service
  youtube-uploader:
    build:
      context: .
      dockerfile: ./youtube-uploader/Dockerfile
    container_name: ichat-youtube-uploader
    ports:
      - "8097:8097"
    environment:
      - FLASK_PORT=8097
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/news?authSource=admin
      - VIDEO_BASE_PATH=/app/public
      - VIDEO_GENERATOR_URL=http://ichat-video-generator:8095
      - LLM_SERVICE_URL=http://ichat-llm-service:8083
      - DEFAULT_CATEGORY_ID=25
      - DEFAULT_PRIVACY_STATUS=private
      - DEFAULT_TAGS=news,hindi news,breaking news,latest news
    volumes:
      - ./youtube-uploader/logs:/app/logs
      - ./youtube-uploader/credentials:/app/credentials
      - ./jobs/video-generator/public:/app/public:ro  # Read-only access to videos
    networks:
      - ichat-network
    depends_on:
      - ichat-mongodb
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8097/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # Auth Service - Authentication and User Management
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: ichat-auth-service
    ports:
      - "8098:8098"
    environment:
      # Flask Configuration
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8098
      - FLASK_DEBUG=false
      - FLASK_ENV=production
      # MongoDB Configuration
      - MONGODB_HOST=ichat-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=news
      - MONGODB_USERNAME=ichat_app
      - MONGODB_PASSWORD=ichat_app_password_2024
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/news?authSource=admin
      # JWT Configuration
      - JWT_SECRET_KEY=your-super-secret-jwt-key-change-in-production-2024
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION_HOURS=24
      # Password Configuration
      - BCRYPT_ROUNDS=12
      - MIN_PASSWORD_LENGTH=8
      # Account Lockout Configuration
      - MAX_FAILED_LOGIN_ATTEMPTS=5
      - ACCOUNT_LOCKOUT_MINUTES=30
      # Logging
      - LOG_LEVEL=INFO
      - LOG_FILE=logs/auth-service.log
    volumes:
      - ./auth-service/logs:/app/logs
    networks:
      - ichat-network
    depends_on:
      - ichat-mongodb
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8098/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # Cleanup Job Service - Deletes old news articles and their files
  job-cleanup:
    build:
      context: ./jobs
      dockerfile: cleanup/Dockerfile
    container_name: ichat-cleanup
    ports:
      - "8100:8100"
    environment:
      # Flask Configuration
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8100
      - FLASK_DEBUG=false
      - FLASK_ENV=production
      # Job Configuration - Run every 1 hour (3600 seconds)
      - JOB_INTERVAL_SECONDS=3600
      - LOG_LEVEL=INFO
      - LOG_FILE=logs/cleanup.log
      # MongoDB Configuration
      - MONGODB_HOST=ichat-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=ichat_db
      - MONGODB_USERNAME=ichat_app
      - MONGODB_PASSWORD=ichat_app_password_2024
      - MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/ichat_db?authSource=admin
      # News Database Configuration
      - NEWS_MONGODB_DATABASE=news
      - NEWS_MONGODB_URL=mongodb://ichat_app:ichat_app_password_2024@ichat-mongodb:27017/news?authSource=admin
      # Cleanup Configuration
      - CLEANUP_RETENTION_HOURS=4
      - CLEANUP_DRY_RUN=false
      - CLEANUP_BATCH_SIZE=100
      - CLEANUP_MAX_ARTICLES_PER_RUN=10000
      # File Paths Configuration
      - VIDEO_PUBLIC_DIR=/app/video_public
      - AUDIO_PUBLIC_DIR=/app/audio_public
      - IMAGE_PUBLIC_DIR=/app/image_public
    volumes:
      - ./jobs/cleanup/logs:/app/logs
      - ./jobs/video-generator/public:/app/video_public
      - ./audio-generation/public:/app/audio_public
      - ./jobs/watermark-remover/public:/app/image_public
    networks:
      - ichat-network
    depends_on:
      - ichat-mongodb
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8100/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # MongoDB Database Service
  ichat-mongodb:
    build:
      context: ./mongodb
      dockerfile: Dockerfile
    container_name: ichat-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=ichat_admin
      - MONGO_INITDB_ROOT_PASSWORD=ichat_secure_password_2024
      - MONGO_INITDB_DATABASE=ichat_db
    volumes:
      - ./mongodb/data:/data/db
      - ./mongodb/logs:/var/log/mongodb
    networks:
      - ichat-network
    command: [ "mongod", "--auth", "--bind_ip_all", "--logpath", "/var/log/mongodb/mongod.log", "--logappend" ]
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

networks:
  ichat-network:
    driver: bridge
    name: ichat-network

volumes:
  api-logs:
    driver: local
  ocr-uploads:
    driver: local
  ocr-outputs:
    driver: local
  ocr-logs:
    driver: local
  llm-logs:
    driver: local
  llm-cache:
    driver: local
  embedding-logs:
    driver: local
  vector-db-data:
    driver: local
  vector-db-logs:
    driver: local
  retriever-logs:
    driver: local
  code-generation-logs:
    driver: local
  code-generation-temp:
    driver: local
  mcp-logs:
    driver: local
  mcp-data:
    driver: local
  mcp-temp:
    driver: local
  llm-model-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./llm/llm-prompt-generation/cache


